# JSON Formatter 部署事故复盘 (2025-12-23)

## ❌ 事故概述
在部署 JSON Formatter 到生产环境时，由于采用不安全的脚本直接修改服务器即时代码，导致了严重的连锁反应：
1. Template 语法错误 (Jinja2 崩溃)
2. Python 缩进错误 (Flask 崩溃)
3. 错误的异常捕获掩盖了真相 (404 假象)

整个过程导致网站服务中断，且由于排查方向错误（被误导），耗费了大量时间。

## 💥 根本原因 (Root Cause Analysis)

### 1. 危险的代码修改方式
**错误行为**：使用基于字符串查找/替换 (`.replace()`) 的 Python 脚本，直接在服务器上修改复杂的代码文件（如 `blog.py`, `tools.py`）。
**后果**：
- 破坏了 Python 的缩进结构（IndentationError）。
- 在函数中间插入代码，截断了逻辑。
- 破坏了 HTML 模板的闭合标签（缺少 `{% endif %}`）。

### 2. 也是最大的坑：异常吞噬
**错误代码**：
```python
try:
    from routes import tools, ...
except:
    # 加载 DummyBP (假蓝图)
    pass
```
**后果**：这层"保护壳"捕获了 `blog.py` 的 Import Error，导致服务器看起来启动成功，但实际上加载的是空路由。这导致了令人困惑的 404 错误，误导排查方向去查数据库和 URL 配置，完全偏离了真正的代码错误。

## ✅ 黄金法则 (Golden Rules for Future)

为了避免再次发生此类事故，今后的开发必须严格遵守以下规则：

### 规则 1：禁止"字符串替换"流部署
**绝对禁止**写脚本去服务器上 `replace` 现有文件的内容。
- **正确做法**：在本地生成**完整**的、经过测试的正确文件。
- **正确做法**：使用 `scp` 上传**整个文件**覆盖服务器上的旧版本。
- 文件级别覆盖 >>>>>>> 字符串级别修补。

### 规则 2：不要在 app.py 里设计"假成功"
在生产环境中，**Let it crash!**
- 如果 import 失败，就让它崩溃并在日志里报错。
- 不要用 `try...except` 吞掉初始化阶段的错误，这会掩盖真相。

### 3. 日志先行
- 遇到 "404 Not Found" 但理论上不应该时，第一时间怀疑 **路由注册失败**。
- 遇到 "500 Internal Error"，第一时间看 **Gunicorn 错误日志**。
- 不要盲目修改数据库逻辑。

## ⚠️ 警示
**Robot, Remember this:**
缩进是 Python 的生命。永远不要用 regex 或 replace 去赌运气修改缩进敏感的代码。
生成全量文件 -> 上传 -> 重启。这是唯一稳妥的路径。
